# FIN schema

## MVP

Минимальная функция:

* начальные остатки
* периодические (еженедельно, ежемесячно) фин операции - выплаты и поступления
* разовые фин операции
* контракты: группы операций - группируются через тэги со значением из списка (контракты)
* добавляем аналитические признаки - счёт БДДС, субсчёт, суб-субсчёт, контрагент, контракт, проект 
* детализация временной шкалы: день, неделя
* отображение платежного календаря на текущую неделю с отображением 
  в pivot table - группировка данных внутри платежного календаря с распределением по указанной 
  степени детальности (день, неделя)
* разные планы
* простые тэги финансовой операции (счета, контракты и тп)
* иерархические тэги
* тэги со ссылкой (тип тэга предполагает ссылку на некий обьект в системе)
* тэги с простым значением
* тэги со значением из списка


### FinOp: Финансовая операция

* id: идентификатор операции
* isPeriodic: (boolean) периодическая операция
* type:
  * 0: нет данных
  * 1: нач остаток
  * 2: поступление
  * 3: выплата
* planId: идентификатор финансового плана, к которому относится операция (пусто для фактов)
* date: дата операции
* caption: описание
* summ: сумма
* partyId: (-> FinParty.id) наша сторона (юр лицо или компания)
* customerPartyId: (-> FinParty.id) контрагент
* finTags: ([FinTag]) массив тэгов финансовой операции
  (?) план - один из тэгов? факт - один из тэгов?
  (?) тип (нач ост/поступление/выплата) - тоже тэг?
  
### FinOpPeriodic: периодическая финансовая операция

Дополнение к операции, описывающая периодическую операцию: как именно повторяется периодическая операция. 
Дата в этом случае - начало периода, когда операция начинает повторяться.

* id: ссылка на фин операцию
* period: (weekly / monthly)
* num: 
  * для недели - в какой день недели (от 1 до 7)
  * для месяца: в какой день (1-31, 32 - всегда в последний день месяца)
* dateEnd: конец интервала повторения

(? *на будущее*:
* maxDuration: длительность повторения в днях
* maxDurationIsWD: признак, что длительность указана в рабочих днях
)


### FinPlan

* id:
* caption: название фин плана

### FinTagSimple: простой тэг фин операции

* id
* caption

### FinTagTree: иерархический тэг

* id:
* parentId:
* caption

### FinTagEnum

* id: 
* caption:
* values:
* captions:

### FinTagRef

* id:
* caption
* refType

### FinOpTagContract

* id: (-> FinOp.id) ссылка на операцию
* contractId


### FinAccount

Счёт учёта в финансовой подсистеме

* id: идентификатор
* caption: 
* bddsType: тип счёта для БДДС
  * 0: не известно
  * 1: поступление
  * 2: выплата
  * 3: иное
* party_id: контрагент для ведения счёта 

### FinParty

Контрагент - справочник контрагентов (юридических, физических лиц и тп)

* id: идентификатор контрагента
* caption: название
* type: 
  0: не известно
  1: физическое лицо (Person)
  2: ИП (PersonBiz)
  3: самозанятый (PersonSelfEmp)
  4: юридическое лицо (Company)
  5: банк (Bank)
  (6: брокер, страховая компания, лизинговая) 
  10: иное


### FinBudget: платежный календарь

На входе:

* дата начала периода
* дата окончания периода
* детализация - неделя, день
* список тэгов с параметрами каждого

Фильтрация:

* делаем отбор по датам
* делаем отбор по указанным тегам
* делаем отбор по тэгам, которых быть не должно

Возвращается массив плоских данных:

* (основные поля фин операции)
* (развернутые иерархические тэги)
* (добавить тэги со ссылками на обьекты, добавить указанные поля из обьектов - по пути)
* (добавить value тэги)
* (добавить boolean тэги)


### Считаем остаток на начало периода

Берем дату начала периода. Ищем ближайшую к ней дату внесения начальных остатков. Берем все операции от даты внесения остатков (включительно) до даты начала периода (не включая ее), ссумируем выручку, вычитаем выплаты. Итог - остаток на начало периода.







